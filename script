--!strict
-- TSB Combat System v5.2 (Complete) with Dash and HP Damage
local Player = game:GetService("Players").LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
local UIS = game:GetService("UserInputService")
local RS = game:GetService("RunService")
local TS = game:GetService("TweenService")
local SoundService = game:GetService("SoundService")

------ [КОНФИГУРАЦИЯ] ------
local CONFIG = {
    Keybinds = {
        LightAttack = {Key = Enum.KeyCode.Q, Text = "[Q] Легкая атака", Color = Color3.fromRGB(255, 100, 100)},
        HeavyAttack = {Key = Enum.KeyCode.E, Text = "[E] Тяжелая атака", Color = Color3.fromRGB(255, 50, 50)},
        SpecialAttack = {Key = Enum.KeyCode.R, Text = "[R] Ульт.атака", Color = Color3.fromRGB(200, 0, 200)},
        Dash = {Key = Enum.KeyCode.LeftControl, Text = "[Ctrl] Рывок", Color = Color3.fromRGB(100, 200, 255)},
        Block = {Key = Enum.KeyCode.F, Text = "[F] Блок", Color = Color3.fromRGB(100, 100, 255)}
    },
    
    Animations = {
        LightAttack = "rbxassetid://9124234871",
        HeavyAttack = "rbxassetid://9124236723",
        SpecialAttack = "rbxassetid://9124238912",
        Dash = "rbxassetid://9124240567",
        Block = "rbxassetid://9124241234"
    },
    
    Effects = {
        Blood = {
            Particle = {
                Color = ColorSequence.new(Color3.fromRGB(150, 0, 0)),
                Size = NumberSequence.new(0.5),
                Lifetime = 0.8,
                Speed = 5,
                Texture = "rbxassetid://242842001"
            }
        },
        Shockwave = {
            MeshId = "rbxassetid://9422001123",
            Color = Color3.fromRGB(255, 150, 50),
            TweenInfo = TweenInfo.new(0.5, Enum.EasingStyle.Quad)
        },
        DashTrail = {
            Color = ColorSequence.new(Color3.fromRGB(100, 200, 255)),
            Lifetime = 0.7,
            Width = 0.5
        }
    },
    
    Audio = {
        BackgroundMusic = 134713831368801,
        HitSounds = {
            Light = "rbxassetid://9421996611",
            Heavy = "rbxassetid://9422001123",
            Dash = "rbxassetid://130785433"
        }
    },
    
    Combat = {
        StaminaRegen = 0.7,
        AttackCosts = {Light = 10, Heavy = 20, Special = 30, Dash = 15},
        Damage = {Light = 15, Heavy = 30, Special = 45},
        ComboResetTime = 2.5,
        DashSpeed = 80,
        DashDuration = 0.3,
        DashCooldown = 0.8,
        AttackRange = 10,
        HitboxSize = Vector3.new(5, 5, 5)
    }
}

------ [АУДИО СИСТЕМА] ------
local function PlayBackgroundMusic()
    local sound = Instance.new("Sound")
    sound.SoundId = "rbxassetid://"..CONFIG.Audio.BackgroundMusic
    sound.Looped = true
    sound.Volume = 0.5
    sound.Parent = SoundService
    sound:Play()
    
    game:GetService("UserInputService").WindowFocusReleased:Connect(function()
        sound.Volume = 0.2
    end)
    
    game:GetService("UserInputService").WindowFocused:Connect(function()
        sound.Volume = 0.5
    end)
end

local function PlayHitSound(type)
    local sound = Instance.new("Sound")
    sound.SoundId = CONFIG.Audio.HitSounds[type] or CONFIG.Audio.HitSounds.Light
    sound.Volume = 0.6
    sound.Parent = HumanoidRootPart
    sound:Play()
    game.Debris:AddItem(sound, 2)
end

------ [ИНТЕРФЕЙС] ------
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "TSB_CombatUI"
ScreenGui.Parent = Player:WaitForChild("PlayerGui")

local KeybindsFrame = Instance.new("Frame")
KeybindsFrame.Size = UDim2.new(0.22, 0, 0.22, 0)
KeybindsFrame.Position = UDim2.new(0.02, 0, 0.7, 0)
KeybindsFrame.BackgroundTransparency = 0.85
KeybindsFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
KeybindsFrame.Parent = ScreenGui

TS:Create(KeybindsFrame, TweenInfo.new(0.7), {Position = UDim2.new(0.02, 0, 0.68, 0)}):Play()

local Title = Instance.new("TextLabel")
Title.Text = "⚔️ БОЕВАЯ СИСТЕМА ⚔️"
Title.TextColor3 = Color3.fromRGB(255, 215, 0)
Title.Font = Enum.Font.GothamBlack
Title.TextSize = 18
Title.Size = UDim2.new(1, 0, 0.2, 0)
Title.BackgroundTransparency = 1
Title.Parent = KeybindsFrame

local yOffset = 0.25
for _, bind in pairs(CONFIG.Keybinds) do
    local button = Instance.new("TextButton")
    button.Text = bind.Text
    button.TextColor3 = bind.Color
    button.Font = Enum.Font.GothamBold
    button.TextSize = 14
    button.Size = UDim2.new(1, -10, 0.15, 0)
    button.Position = UDim2.new(0, 10, yOffset, 0)
    button.TextXAlignment = Enum.TextXAlignment.Left
    button.BackgroundTransparency = 1
    button.AutoButtonColor = false
    button.Parent = KeybindsFrame
    
    button.MouseEnter:Connect(function()
        TS:Create(button, TweenInfo.new(0.2), {TextColor3 = Color3.new(1,1,1)}):Play()
    end)
    
    button.MouseLeave:Connect(function()
        TS:Create(button, TweenInfo.new(0.2), {TextColor3 = bind.Color}):Play()
    end)
    
    yOffset = yOffset + 0.16
end

------ [ЭФФЕКТЫ] ------
local function CreateParticleEffect(parent, config)
    local emitter = Instance.new("ParticleEmitter")
    emitter.LightEmission = 0.8
    for prop, value in pairs(config) do
        emitter[prop] = value
    end
    emitter.Parent = parent
    game.Debris:AddItem(emitter, config.Lifetime or 1)
    return emitter
end

local function CreateBloodEffect(position)
    local part = Instance.new("Part")
    part.Anchored = true
    part.CanCollide = false
    part.Transparency = 1
    part.Position = position
    part.Parent = workspace
    
    CreateParticleEffect(part, CONFIG.Effects.Blood.Particle)
    game.Debris:AddItem(part, 1)
end

local function CreateShockwave(position)
    local wave = Instance.new("MeshPart")
    wave.MeshId = CONFIG.Effects.Shockwave.MeshId
    wave.Size = Vector3.new(3, 0.1, 3)
    wave.Color = CONFIG.Effects.Shockwave.Color
    wave.Material = Enum.Material.Neon
    wave.CFrame = CFrame.new(position) * CFrame.Angles(math.rad(90), 0, 0)
    wave.Anchored = true
    wave.CanCollide = false
    wave.Parent = workspace
    
    local tween = TS:Create(
        wave,
        CONFIG.Effects.Shockwave.TweenInfo,
        {Size = Vector3.new(12, 0.1, 12), Transparency = 1}
    )
    tween:Play()
    tween.Completed:Connect(function() wave:Destroy() end)
end

local function CreateDashTrail()
    local trail = Instance.new("Trail")
    trail.Attachment0 = HumanoidRootPart:FindFirstChild("RootAttachment") or 
                       Instance.new("Attachment", HumanoidRootPart)
    trail.Attachment1 = trail.Attachment0:Clone()
    trail.Attachment1.Parent = HumanoidRootPart
    trail.Color = CONFIG.Effects.DashTrail.Color
    trail.Lifetime = CONFIG.Effects.DashTrail.Lifetime
    trail.WidthScale = NumberSequence.new(CONFIG.Effects.DashTrail.Width)
    trail.Parent = HumanoidRootPart
    
    return trail
end

------ [СИСТЕМА БОЯ] ------
local Combat = {
    Stamina = 100,
    Combo = 0,
    LastAttack = 0,
    Cooldowns = {},
    IsDashing = false
}

-- Загрузка анимаций
local Anims = {}
for name, id in pairs(CONFIG.Animations) do
    local anim = Instance.new("Animation")
    anim.AnimationId = id
    Anims[name] = Humanoid:LoadAnimation(anim)
    Anims[name].Priority = Enum.AnimationPriority.Action
end

local function GetHitboxCFrame()
    return HumanoidRootPart.CFrame * CFrame.new(0, 0, -CONFIG.Combat.AttackRange/2)
end

local function DealDamage(target, damage)
    if target and target:FindFirstChild("Humanoid") then
        target.Humanoid:TakeDamage(damage)
        return true
    end
    return false
end

local function FindTargets()
    local hitboxCFrame = GetHitboxCFrame()
    local hitboxSize = CONFIG.Combat.HitboxSize
    
    local parts = workspace:GetPartsInPart(HumanoidRootPart, hitboxCFrame, hitboxSize)
    local targets = {}
    
    for _, part in ipairs(parts) do
        local character = part:FindFirstAncestorOfClass("Model")
        if character and character ~= Character and character:FindFirstChild("Humanoid") then
            if not table.find(targets, character) then
                table.insert(targets, character)
            end
        end
    end
    
    return targets
end

local function Attack(type)
    local cost = CONFIG.Combat.AttackCosts[type]
    if Combat.Cooldowns[type] or Combat.Stamina < cost or Combat.IsDashing then return end
    
    Combat.Cooldowns[type] = true
    Combat.Stamina = Combat.Stamina - cost
    Combat.Combo = Combat.Combo + 1
    Combat.LastAttack = os.clock()
    
    Anims[type.."Attack"]:Play()
    PlayHitSound(type)
    
    -- Поиск целей в хитбоксе
    local targets = FindTargets()
    local damage = CONFIG.Combat.Damage[type] * (1 + Combat.Combo * 0.1)
    
    for _, target in ipairs(targets) do
        if DealDamage(target, damage) then
            CreateBloodEffect(target.HumanoidRootPart.Position)
            if type ~= "Light" then
                CreateShockwave(target.HumanoidRootPart.Position + Vector3.new(0, 0.5, 0))
            end
        end
    end
    
    task.delay(0.5, function() Combat.Cooldowns[type] = false end)
end

local function Dash()
    if Combat.Cooldowns.Dash or Combat.Stamina < CONFIG.Combat.AttackCosts.Dash or Combat.IsDashing then return end
    
    Combat.Cooldowns.Dash = true
    Combat.Stamina = Combat.Stamina - CONFIG.Combat.AttackCosts.Dash
    Combat.IsDashing = true
    
    Anims.Dash:Play()
    PlayHitSound("Dash")
    
    local trail = CreateDashTrail()
    local startTime = os.clock()
    local direction = HumanoidRootPart.CFrame.LookVector
    
    -- Применение рывка
    HumanoidRootPart.AssemblyLinearVelocity = direction * CONFIG.Combat.DashSpeed
    
    -- Проверка на столкновение во время рывка
    local dashConnection
    dashConnection = RS.Heartbeat:Connect(function()
        if os.clock() - startTime >= CONFIG.Combat.DashDuration then
            dashConnection:Disconnect()
            Combat.IsDashing = false
            trail:Destroy()
            
            -- Нанесение урона при прохождении сквозь врагов
            local targets = FindTargets()
            for _, target in ipairs(targets) do
                DealDamage(target, CONFIG.Combat.Damage.Light * 0.5)
            end
        end
    end)
    
    task.delay(CONFIG.Combat.DashCooldown, function() Combat.Cooldowns.Dash = false end)
end

------ [ОБРАБОТКА ВВОДА] ------
UIS.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == CONFIG.Keybinds.LightAttack.Key then
        Attack("Light")
    elseif input.KeyCode == CONFIG.Keybinds.HeavyAttack.Key then
        Attack("Heavy")
    elseif input.KeyCode == CONFIG.Keybinds.SpecialAttack.Key then
        Attack("Special")
    elseif input.KeyCode == CONFIG.Keybinds.Dash.Key then
        Dash()
    elseif input.KeyCode == CONFIG.Keybinds.Block.Key then
        Anims.Block:Play()
    end
end)

------ [ОСНОВНОЙ ЦИКЛ] ------
RS.Heartbeat:Connect(function(delta)
    -- Регенерация стамины
    if Combat.Stamina < 100 then
        Combat.Stamina = math.min(Combat.Stamina + CONFIG.Combat.StaminaRegen * delta * 60, 100)
    end
    
    -- Сброс комбо
    if Combat.Combo > 0 and (os.clock() - Combat.LastAttack) > CONFIG.Combat.ComboResetTime then
        Combat.Combo = 0
    end
end)

-- Запуск системы
task.spawn(PlayBackgroundMusic)
print("✅ TSB Combat System v5.2 loaded! Music & Effects activated")
